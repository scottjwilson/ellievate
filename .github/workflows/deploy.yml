name: Deploy Website

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: ðŸš€ Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¥ Install Dependencies
        run: npm ci

      - name: ðŸ”¨ Build Assets
        run: npm run build

      - name: ðŸ“‹ List dist folder
        run: ls -la dist/

      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p 6543 165.140.159.249 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ðŸ§ª Test SSH Connection
        run: |
          ssh -v -i ~/.ssh/deploy_key -p 6543 -o StrictHostKeyChecking=no -o ConnectTimeout=10 ellievatedbeautycom@165.140.159.249 "echo 'SSH connection successful'"

      - name: ðŸ“‚ Deploy via rsync
        run: |
          rsync -avz --delete \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=.github \
            -e "ssh -i ~/.ssh/deploy_key -p 6543 -o StrictHostKeyChecking=no" \
            ./ ellievatedbeautycom@165.140.159.249:/home/ellievatedbeautycom/public_html/wp-content/themes/ballstreet2/
